name: documentation
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  release:
    types:
      - created
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

jobs:
  build:
    if: |
      (github.event.pull_request.draft == false) ||
      (github.event_name == 'workflow_dispatch') ||
      (github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Cache conda
        uses: actions/cache@v2
        env:
          # Increase this value to reset cache if ./environment.yml has not changed
          CACHE_NUMBER: 0
        with:
          path: |
            ~/conda_pkgs_dir
            ~/.cache/pip
          key: ${{ runner.os }}-conda-${{ env.CACHE_NUMBER }}-${{ hashFiles('./doc/rtd_environment.yml', './setup.cfg') }}

      - name: Setup Conda Environment
        uses: mamba-org/provision-with-micromamba@v10
        with:
          environment-file: ./doc/rtd_environment.yml
          environment-name: rtd

      - name: activate build env
        shell: bash -l {0}
        run: micromamba activate rtd

      - name: install dev version again
        # There is a bug in micromamba, which cd's out of the working-directory during the pip install of weldx.
        # So the initial env creation lacks weldx, so we install it here.
        shell: bash -l {0}
        run: pwd && pip install -e . && pip install git+https://github.com/CagtayFabry/sphinx-asdf.git@sphinx-weldx

      - name: conda info
        shell: bash -l {0}
        run: conda info

      - name: conda list
        shell: bash -l {0}
        run: conda list

      - name: install weldx kernel
        shell: bash -l {0}
        run: ipython kernel install --user --name=weldx

      - name: Build docs
        shell: bash -l {0}
        run: sphinx-build -W -n -b html -d build/doctrees doc build/html --keep-going

      - uses: actions/upload-artifact@v1
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'release' && github.event.action == 'created')
        with:
          name: weldx-docs
          path: build/html
